<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Translate SignLanguage-VietNamese</title>

    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <link rel="shortcut icon" href="static/icons8-translate-text-96.png">
    <link rel="stylesheet" href="static/index.css">

</head>

<body>

    <div class='container-fluid intro border' style="text-align: center;">
        <img src="static/ptit.png" alt="" srcset="" style="float: left; width:70px; height: auto; margin-left: 20px;">
        <h2 class="mt-3 mb-3">Từ điển Ngôn ngữ Kí hiệu - Tiếng Việt</h2>
    </div>


    <div class='container main vn-sl'>

        <div class='row mt-5 title'>
            <div class='col-sm-5 root' style="text-align: center;">
                <h4>Tiếng Việt</h4>
            </div>

            <div class='col-sm-2 change_icon ' style="text-align: center;">
                <i class="fa fa-exchange pt-1" aria-hidden="true" style="font-size: 30px; cursor: pointer;"></i>
            </div>

            <div class='col-sm-5 root ' style="text-align: center;">
                <h4>Ngôn ngữ kí hiệu</h4>
            </div>
        </div>

        <div class="row border block_main">

            <div class='col-sm-6 root_content' style="text-align: center; ">

                <input class="form-control" type="text" name="" id="" placeholder="Nhập từ tiếng việt">

                <button type="button" class="btn btn-primary dich-vn-sl mb-3">Dịch</button>

            </div>

            <div class='col-sm-6 translate pt-3 pb-3 ' style=" text-align: center; border: 2px solid #0097e6; min-height: 300px;">

            </div>
        </div>

    </div>

    <div class='container main sl-vn' style="display:none;">

        <div class='row mt-5 title'>
            <div class='col-5 root ' style="text-align: center;">
                <h4>Ngôn ngữ kí hiệu</h4>
            </div>

            <div class='col-2 change_icon ' style="text-align: center;">
                <i class="fa fa-exchange pt-1" aria-hidden="true" style="font-size: 30px; cursor: pointer;"></i>
            </div>

            <div class='col-5 root ' style="text-align: center;">
                <h4>Tiếng Việt</h4>
            </div>
        </div>

        <div class="row border block_main">
            <div class='col-6 pt-3 pb-3 ' style=" text-align: center; border: 2px solid #0097e6;">

                <div class='show_video mb-2'>
                    <video id="vid2" controls src="#" style="width:420px; height: 260px;"></video>
                </div>

                <!-- <button type="file" class="btn btn-primary btn_d" accept="video/*">Tải file</button> -->

                <!-- <label for="upload" class="mr-3 border" style="background-color: #3498db">Tải file</label> -->

                <input id='upload' type="file" name="file[]" class="file_multi_video" accept="video/*">

                <button id='open_cam' type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal">
                    Quay trực tuyến
                </button>
                <!-- The Modal -->
                <div class="modal fade" id="myModal">
                    <div class="modal-dialog modal-lg" style="width:600px">
                        <div class="modal-content">

                            <!-- Modal Header -->
                            <div class="modal-header">
                                <h4 class="modal-title">Quay trực tuyến</h4>
                                <button id='close_camera' type="button" class="close" data-dismiss="modal">&times;</button>
                            </div>

                            <!-- Modal body -->
                            <div class="modal-body">
                                <video id="vid1" controls style="margin-left: 13px;"></video>

                            </div>

                            <!-- Modal footer -->
                            <div class="modal-footer" style="align-items: center;">
                                <i id="btnStart" class="fa fa-video-camera" aria-hidden="true" style="font-size: 35px; color: #2980b9;"></i>

                                <i id="btnStop" class="fa fa-stop" aria-hidden="true" style='font-size: 35px;display:none; color: red;'></i>

                                <button id='preview' type="button" class="btn btn-warning" style='margin-left:30%;float: right; font-size: 16px; font-weight: 550;'>Pre-view</button>
                            </div>

                        </div>
                    </div>
                </div>
                <button id='predict' type="button" class="btn btn-primary btn_d">Dịch</button>
            </div>
            <div class='col-6 root_content2 ' style="text-align: center; ">

                <h3 id='label' style="padding-top: 20%;"></h3>
                <h3 id='conff' style="padding-top: 5%;"></h3>

            </div>
        </div>
    </div>

    </div>

    <div class="container-fluid border mt-5" style="text-align: center;">

        <h5 class="mt-2 ">Copyright: PTIT Team</h5>

        <div class="contact ">
            <i class="fa fa-facebook-square " aria-hidden="true "></i>
            <i class="fa fa-youtube-play " aria-hidden="true "></i>
            <i class="fa fa-github " aria-hidden="true "></i>
            <i class="fa fa-envelope-o " aria-hidden="true "></i>
        </div>

        <div class="mt-3" style="color: red; ">

            <h6 class="mt-2">Vesion: Beta 2.2</h6>

        </div>
    </div>

    <script>
        let constraintObj = {
            audio: false,
            video: {
                facingMode: "user",
                width: {
                    min: 540,
                    ideal: 540,
                    max: 540
                },
                height: {
                    min: 360,
                    ideal: 360,
                    max: 360
                }
            }
        };

        $('#close_camera').click(function() {

            // clear the camera
            localStream.getTracks().forEach((track) => {
                track.stop();
            });
            // localStorage.clear();

        });

        $("#upload").change(function() {
            var fileInput = document.getElementById('upload');
            var fileUrl = window.URL.createObjectURL(fileInput.files[0]);
            $("#vid2").attr("src", fileUrl);
        });


        $('#open_cam').click(function() {


            if (navigator.mediaDevices === undefined) {
                navigator.mediaDevices = {};
                navigator.mediaDevices.getUserMedia = function(constraintObj) {
                    let getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
                    if (!getUserMedia) {
                        return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
                    }
                    return new Promise(function(resolve, reject) {
                        getUserMedia.call(navigator, constraintObj, resolve, reject);
                    });
                }
            } else {
                navigator.mediaDevices.enumerateDevices()
                    .then(devices => {

                        devices.forEach(device => {
                            console.log(device.kind.toUpperCase(), device.label);
                            //, device.deviceId
                        })
                    })
                    .catch(err => {
                        console.log(err.name, err.message);
                    })
            }

            navigator.mediaDevices.getUserMedia(constraintObj)
                .then(function(mediaStreamObj) {
                    //connect the media stream to the first video element
                    window.localStream = mediaStreamObj;
                    let video = document.getElementById("vid1");
                    if ("srcObject" in video) {
                        video.srcObject = mediaStreamObj;
                    } else {
                        //old version
                        video.src = window.URL.createObjectURL(mediaStreamObj);
                    }

                    video.onloadedmetadata = function(ev) {
                        //show in the video element what is being captured by the webcam
                        video.play();
                    };

                    //add listeners for saving video/audio
                    let vidSave = document.getElementById("vid2");
                    let mediaRecorder = new MediaRecorder(mediaStreamObj);
                    let chunks = [];

                    $('#btnStart').click(function() {

                        mediaRecorder.start();
                        $('#btnStop').css('display', 'inline');
                        $('#btnStart').css('display', 'none');
                    });

                    $('#btnStop').click(function() {
                        mediaRecorder.stop();
                        $('#btnStart').css('display', 'inline');
                        $('#btnStop').css('display', 'none');

                    });

                    mediaRecorder.ondataavailable = function(ev) {
                        chunks.push(ev.data);
                    }
                    mediaRecorder.onstop = (ev) => {


                        let blob = new Blob(chunks, {
                            'type': 'video/webm'
                        });
                        chunks = [];
                        let videoURL = window.URL.createObjectURL(blob);
                        vidSave.src = videoURL;
                    }
                    $('#preview').click(function() {

                        alert('Chế độ xem trước');
                    });
                })
                .catch(function(err) {
                    console.log(err.name, err.message);
                });
        });

        $("#predict").click(async function() {

            // $('.root_content2').append()

            let vidSave = document.getElementById("vid2");
            let blod_data = await fetch(vidSave.src).then(r => r.blob());

            alert("Send video to sever...");

            let size_file = blod_data.size * 1e-6; // covert byte to MB
            if (size_file > 10) {

                alert("Kích thước file gửi đi có dung lượng quá lớn size = " + size_file.toFixed(2) + " MB");

            } else {

                let loading = '<div class="spinner-border text-primary" role="status" style="margin-top:25%; margin-left:15%"><span class="sr-only">Loading...</span></div>';
                $('.root_content2').empty();
                $('.root_content2').append(loading);
                var reader = new FileReader();
                reader.readAsDataURL(blod_data);
                reader.onloadend = function() {
                    let base64data = reader.result;

                    url_send = '/slvn';

                    if (vidSave.duration > 5.2) {
                        url_send = '/slvn-sequence'
                    }
                    // alert(base64data);
                    $.ajax({
                        url: url_send,
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            data: base64data
                        },
                        success: function(result) {
                            if (result['success'] == 'true') {

                                $('.root_content2').empty();
                                $('.root_content2').append('<h3 id="label" style="padding-top: 20%;"></h3>');
                                $('.root_content2').append('<h3 id="conff" style="padding-top: 5%;"></h3>');

                                let label = document.getElementById("label");
                                let conff = document.getElementById("conff");

                                label.innerText = "Từ: " + result['label'];
                                let xs = parseFloat(result['conff']);
                                xs = xs * 100;
                                xs = xs.toFixed(2);
                                conff.innerText = "Xác xuất: " + xs + " %";

                            } else {

                            }
                        }
                    });
                    base64data = "";
                };
            }

        });
        $(document).ready(function() {

            // alert("New Update Version: 2.0 \n 1. Tối ưu hóa giao diện tìm kiếm. \n 2. Tối ưu hóa kết quả tìm kiếm.\n 3. Tối ưu hóa giao diện mobile. \n 4. Hỗ trợ tìm kiếm tiếng việt không dấu.");
            var status = 0;
            $('.fa-exchange').click(function() {

                if (status == 0) {

                    $(".vn-sl").css('display', 'none');
                    $(".sl-vn").css('display', 'block');
                    status = 1;
                } else {
                    status = 0;
                    $(".vn-sl").css('display', 'block');
                    $(".sl-vn").css('display', 'none');
                }

            });
            $(document).ajaxStart(function() {
                $("#loading").show();
            }).ajaxStop(function() {
                $("#loading").hide();
            });
            $(".dich-vn-sl").click(function() {

                var word = $('.form-control').val();

                let loading = '<div class="spinner-border text-primary" role="status" style="margin-top:25%; margin-left:15%"><span class="sr-only">Loading...</span></div>';
                $('.translate').empty();
                $('.translate').append(loading);

                $.ajax({
                    url: 'vnsl',
                    type: 'POST',
                    dataType: 'json',
                    data: {

                        keyword: word
                    },
                    success: function(result) {

                        if (result['success'] == 'true') {

                            $('.translate').empty();
                            let src = result['src'];
                            let id_video = src.split("=");
                            id_video = id_video[id_video.length - 1];
                            src = "https://www.youtube.com/embed/" + id_video;

                            let frame = "<iframe width='98%' height='97%' src='" + src + "' frameborder='0'> < /iframe>";

                            $('.translate').append(frame);
                        } else {
                            $('.translate').empty();
                            alert("Không tìm thấy từ bạn vừa tìm kiếm. Kiểm tra lại chính tả, và từ có dấu.");
                        }
                    }
                });

            });


        });
    </script>
</body>

</html>